<template><div><h5 id="提测结果" tabindex="-1"><a class="header-anchor" href="#提测结果" aria-hidden="true">#</a> 提测结果</h5>
<p><img src="http://www.iocaop.com/images/2022-08/202208191057395.png" alt="提测结果"></p>
<h5 id="业务流程说明" tabindex="-1"><a class="header-anchor" href="#业务流程说明" aria-hidden="true">#</a> 业务流程说明</h5>
<p>功能：分页查询当前管理员需要改卷的考试列表，列表中对象如下：</p>
<div class="language-json ext-json line-numbers-mode"><pre v-pre class="language-json"><code><span class="token property">"examId"</span><span class="token operator">:</span> <span class="token string">"20220628150358be9e5e442c95efa44c8aa0"</span><span class="token punctuation">,</span> 
        <span class="token property">"examName"</span><span class="token operator">:</span> <span class="token string">"考试名称512"</span><span class="token punctuation">,</span>
        <span class="token property">"questionCount"</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span> 题目数量
        <span class="token property">"subjectiveQuestionCount"</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span> 主观题数量
        <span class="token property">"totalScore"</span><span class="token operator">:</span> <span class="token number">44</span><span class="token punctuation">,</span>
        <span class="token property">"passScore"</span><span class="token operator">:</span> <span class="token number">26</span><span class="token punctuation">,</span>
        <span class="token property">"submitCount"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> 交卷人数
        <span class="token property">"reviewedCount"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 已改卷人数
        <span class="token property">"unReviewedCount"</span><span class="token operator">:</span> <span class="token number">500</span><span class="token punctuation">,</span> 待改卷人数
        <span class="token property">"examStartTime"</span><span class="token operator">:</span> <span class="token string">"2020-04-28 02:18:00"</span><span class="token punctuation">,</span>
        <span class="token property">"examEndTime"</span><span class="token operator">:</span> <span class="token string">"2024-07-09 02:18:00"</span><span class="token punctuation">,</span>
        <span class="token property">"createBy"</span><span class="token operator">:</span> <span class="token string">"admin"</span><span class="token punctuation">,</span>
        <span class="token property">"secretLevel"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
        <span class="token property">"examStatus"</span><span class="token operator">:</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>表结构、关联关系、主要字段：</p>
<ul>
<li>
<p>exam_reviewer考试阅卷人表:exam_id、reviewer_id(ALL为所有管理员可阅卷，管理员id则为指定某个管理员可阅卷)</p>
</li>
<li>
<p>exam考试表：exam_id(主键)、exam_name(考试名次)、total_score(总分)、pass_score(及格分)、start_time(考试开始时间)、end_time(考试结束时间)、create_by(创建者)、secret_level(密卷等级)、source_type(导入试卷1 引入试卷2 组卷3)</p>
</li>
<li>
<p>answer_record答题记录表:id(主键)、is_post(是否交卷)、is_del(逻辑删除、0则为最后一次答题记录，1则为历史答题记录，每次答题会逻辑删除以前的)、is_check_finish(改卷是否完成：默认值0)</p>
</li>
<li>
<p>answer_record_detail(答题记录详情表):record_id(答题记录表主键)、question_id(所答题目的id，根据考试添加类型查不同的表)</p>
</li>
<li>
<p>exam_question表(导入考试和引入考试的题目表，引入考试会从test_paper_question复制题目和选项到这张表)：id(题目主键)、question_type题目类型(1：单选 2：多选 3：填空 4：判断 5：问答)</p>
</li>
</ul>
<p>思路(优化前)：</p>
<ul>
<li>查出当前管理员可以阅卷的所有考试的id：examIdList，即reviewer_id为ALL或当前登录用户id的记录的exam_id字段的集合</li>
<li>筛选examIdList中有最后一次答题记录且对应的答题记录详情中包含主观题(question_type为3或5)的examId</li>
<li>再根据筛选后的examIdList使用id in，配合用户输入的查询条件来查考试表(exam)，查出考试列表，用stream封装返回结果。</li>
</ul>
<h5 id="spring-actuator监控结果" tabindex="-1"><a class="header-anchor" href="#spring-actuator监控结果" aria-hidden="true">#</a> spring-actuator监控结果</h5>
<p>数据库一直在返回数据，网络一直占着</p>
<p><img src="http://www.iocaop.com/images/2022-08/202208191057622.png" alt="spring-actuator监控结果"></p>
<h5 id="代码分析定位" tabindex="-1"><a class="header-anchor" href="#代码分析定位" aria-hidden="true">#</a> 代码分析定位：</h5>
<div class="language-java ext-java line-numbers-mode"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">></span></span> <span class="token function">getExamCorrectExamList</span><span class="token punctuation">(</span>
        <span class="token class-name">ExamCorrectExamListQueryDTO</span> examCorrectExamListQueryDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 参数</span>
        <span class="token class-name">String</span> examName <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getExamName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> pageNo <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> pageSize <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发布时间范围</span>
        <span class="token class-name">String</span> startTime <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> endTime <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">validStr2Date</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">validStr2Date</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token class-name">UserThreadContext</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Exam</span><span class="token punctuation">></span></span> sqlPageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlPageInfo<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlPageInfo<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>pageNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1 获取当前用户可以改卷的试卷id列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> examIds <span class="token operator">=</span> examReviewerService<span class="token punctuation">.</span><span class="token function">getExamIdListByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">AnswerRecord</span><span class="token operator">::</span><span class="token function">getExamId</span><span class="token punctuation">,</span> examIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> answerRecordList <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span><span class="token punctuation">></span></span> answerRecordListMap <span class="token operator">=</span> answerRecordList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span><span class="token class-name">AnswerRecord</span><span class="token operator">::</span><span class="token function">getExamId</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 过滤掉没有人工阅卷的答题记录的试卷id</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>examIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            examIds <span class="token operator">=</span>
                examIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                        examId <span class="token operator">-></span> <span class="token punctuation">{</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> answerRecords <span class="token operator">=</span>
                                baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>
                                    <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">AnswerRecord</span><span class="token operator">::</span><span class="token function">getExamId</span><span class="token punctuation">,</span> examId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> answerRecordList <span class="token operator">=</span> answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>answerRecord <span class="token operator">-></span> <span class="token punctuation">{</span>
                                <span class="token keyword">int</span> checkMethod <span class="token operator">=</span> examQuestionService<span class="token punctuation">.</span><span class="token function">getExamCheckMethodByRecordId</span><span class="token punctuation">(</span>
                                    answerRecord<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> checkMethod <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_USER_CHECK</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">return</span> <span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>answerRecordList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">></span></span> examCorrectExamListDTOList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>examIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 3 按照id查出考试列表</span>
            <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Exam</span><span class="token punctuation">></span></span> examWrapper <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Exam</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">in</span><span class="token punctuation">(</span><span class="token class-name">Exam</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span> examIds<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">Exam</span><span class="token operator">::</span><span class="token function">getExamType</span><span class="token punctuation">,</span> <span class="token class-name">ExamTypeEnum</span><span class="token punctuation">.</span><span class="token constant">EXAM</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">ge</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Exam</span><span class="token operator">::</span><span class="token function">getPublishTime</span><span class="token punctuation">,</span> startTime<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Exam</span><span class="token operator">::</span><span class="token function">getPublishTime</span><span class="token punctuation">,</span> endTime<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">like</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>examName<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Exam</span><span class="token operator">::</span><span class="token function">getExamName</span><span class="token punctuation">,</span> examName<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orderByDesc</span><span class="token punctuation">(</span><span class="token class-name">Exam</span><span class="token operator">::</span><span class="token function">getPublishTime</span><span class="token punctuation">,</span> <span class="token class-name">Exam</span><span class="token operator">::</span><span class="token function">getCreateTime</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sqlPageInfo <span class="token operator">=</span>
                <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">doSelectPageInfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> examService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span>examWrapper<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 4 构建返回结果</span>
            examCorrectExamListDTOList <span class="token operator">=</span>
                sqlPageInfo<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
                        exam <span class="token operator">-></span> <span class="token punctuation">{</span>
                            <span class="token comment">// 该考试的答题记录</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> answerRecords <span class="token operator">=</span>
                                baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>
                                    <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">AnswerRecord</span><span class="token operator">::</span><span class="token function">getExamId</span><span class="token punctuation">,</span> exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 交卷人数</span>

                            <span class="token keyword">int</span> submitCount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>answerRecord <span class="token operator">-></span> answerRecord<span class="token punctuation">.</span><span class="token function">getIsPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_POST</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 已改卷数</span>
                            <span class="token keyword">int</span> reviewedCount <span class="token operator">=</span>
                                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
                                    answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                                            v <span class="token operator">-></span> v<span class="token punctuation">.</span><span class="token function">getIsCheckFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_CHECK_FINISH</span>
                                                <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span><span class="token function">getIsPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_POST</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 未改卷数</span>
                            <span class="token keyword">int</span> unReviewedCount <span class="token operator">=</span>
                                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
                                    answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                                            v <span class="token operator">-></span>
                                                v<span class="token punctuation">.</span><span class="token function">getIsCheckFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                    <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_NOT_CHECK_FINISH</span>
                                                    <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span><span class="token function">getIsPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_POST</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">ExamCorrectExamListDTO</span> examCorrectExamListDTO <span class="token operator">=</span> <span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examId</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examName</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getExamName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">totalScore</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getTotalScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">passScore</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getPassScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">submitCount</span><span class="token punctuation">(</span>submitCount<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">reviewedCount</span><span class="token punctuation">(</span>reviewedCount<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">unReviewedCount</span><span class="token punctuation">(</span>unReviewedCount<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examStartTime</span><span class="token punctuation">(</span>
                                    <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">formatToStr</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DateHelper</span><span class="token punctuation">.</span><span class="token constant">YYYYMMDD_HHMMSS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examEndTime</span><span class="token punctuation">(</span>
                                    <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">formatToStr</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DateHelper</span><span class="token punctuation">.</span><span class="token constant">YYYYMMDD_HHMMSS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examStatus</span><span class="token punctuation">(</span>
                                    exam<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token operator">?</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_STATUS_ON</span>
                                        <span class="token operator">:</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_STATUS_NOT_ON</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">createBy</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getCreateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">secretLevel</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getSecretLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Integer</span> examQuestionCount<span class="token punctuation">;</span>
                            <span class="token class-name">Integer</span> examSubjectiveQuestionCount<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token operator">==</span> <span class="token class-name">QuestionSourceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">ENTER_SOURCE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                examQuestionCount <span class="token operator">=</span> schemaDetailService<span class="token punctuation">.</span><span class="token function">getQuestionCountBySchemaId</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getSchemaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                examSubjectiveQuestionCount <span class="token operator">=</span> schemaDetailService<span class="token punctuation">.</span><span class="token function">getSubjectiveQuestionCountBySchemaId</span><span class="token punctuation">(</span>
                                    exam<span class="token punctuation">.</span><span class="token function">getSchemaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                examSubjectiveQuestionCount <span class="token operator">=</span> examQuestionService<span class="token punctuation">.</span><span class="token function">getSubjectiveQuestionCount</span><span class="token punctuation">(</span>
                                    exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                examQuestionCount <span class="token operator">=</span> examService<span class="token punctuation">.</span><span class="token function">getExamQuestionCount</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            examCorrectExamListDTO<span class="token punctuation">.</span><span class="token function">setSubjectiveQuestionCount</span><span class="token punctuation">(</span>examSubjectiveQuestionCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            examCorrectExamListDTO<span class="token punctuation">.</span><span class="token function">setQuestionCount</span><span class="token punctuation">(</span>examQuestionCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> examCorrectExamListDTO<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5分页</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">></span></span> resultPageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>sqlPageInfo<span class="token punctuation">,</span> resultPageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultPageInfo<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>examCorrectExamListDTOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resultPageInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>影响性能原因：</p>
<ul>
<li>
<p>查询当前用户可以改卷的考试列表id时未做分页，如果可以改卷的考试非常多，光这一步就需要耗费很长时间,且查出很多的多余数据</p>
<div class="language-java ext-java line-numbers-mode"><pre v-pre class="language-java"><code> <span class="token comment">// 1 获取当前用户可以改卷的试卷id列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> examIds <span class="token operator">=</span> examReviewerService<span class="token punctuation">.</span><span class="token function">getExamIdListByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>在循环中查询数据，创建回话过多</p>
<div class="language-java ext-java line-numbers-mode"><pre v-pre class="language-java"><code>        <span class="token comment">// 2 过滤掉没有人工阅卷的答题记录的试卷id</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>examIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            examIds <span class="token operator">=</span>
                examIds<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                        examId <span class="token operator">-></span> <span class="token punctuation">{</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> answerRecords <span class="token operator">=</span>
                                baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>
                                    <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">AnswerRecord</span><span class="token operator">::</span><span class="token function">getExamId</span><span class="token punctuation">,</span> examId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> answerRecordList <span class="token operator">=</span> answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>answerRecord <span class="token operator">-></span> <span class="token punctuation">{</span>
                                <span class="token keyword">int</span> checkMethod <span class="token operator">=</span> examQuestionService<span class="token punctuation">.</span><span class="token function">getExamCheckMethodByRecordId</span><span class="token punctuation">(</span>
                                    answerRecord<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> checkMethod <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_USER_CHECK</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                            <span class="token keyword">return</span> <span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>answerRecordList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>循环中还调用了较为耗费性能的方法(考试发布后，题目可以修改，所以需要根据答题记录id判断阅卷方式):</p>
<div class="language-java ext-java line-numbers-mode"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getExamCheckMethodByRecordId</span><span class="token punctuation">(</span><span class="token class-name">String</span> recordId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> questionIdList <span class="token operator">=</span> answerRecordDetailService<span class="token punctuation">.</span><span class="token function">getQuestionIdListByAnswerRecordId</span><span class="token punctuation">(</span>
            recordId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AnswerRecord</span> answerRecord <span class="token operator">=</span> answerRecordService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>recordId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Exam</span> exam <span class="token operator">=</span> examService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>answerRecord<span class="token punctuation">.</span><span class="token function">getExamId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> exam <span class="token operator">||</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>questionIdList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_SYSTEM_CHECK</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">></span></span> questionType<span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> sourceType <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">QuestionSourceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">EXCEL_SOURCE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> sourceType
            <span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">QuestionSourceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">LIB_SOURCE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 导入和引入试卷</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExamQuestion</span><span class="token punctuation">></span></span> questions <span class="token operator">=</span> <span class="token function">getListByExamIdAndQuestionIdListIgnoreLogicallyDelete</span><span class="token punctuation">(</span>
                answerRecord<span class="token punctuation">.</span><span class="token function">getExamId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> questionIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            questionType <span class="token operator">=</span> questions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">ExamQuestion</span><span class="token operator">::</span><span class="token function">getQuestionType</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LibQuestion</span><span class="token punctuation">></span></span> questions <span class="token operator">=</span> libQuestionService<span class="token punctuation">.</span><span class="token function">getListByQuestionIdListIgnoreLogicallyDelete</span><span class="token punctuation">(</span>
                questionIdList<span class="token punctuation">)</span><span class="token punctuation">;</span>
            questionType <span class="token operator">=</span> questions<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">LibQuestion</span><span class="token operator">::</span><span class="token function">getQuestionType</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>questionType<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ExamQuestionTypeEnum</span><span class="token punctuation">.</span><span class="token constant">QUESTION_TYPE_QA</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> questionType
            <span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token class-name">ExamQuestionTypeEnum<span class="token punctuation">.</span>QUESTION_TYPE_ClOZE</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_USER_CHECK</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_SYSTEM_CHECK</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
</ul>
<h5 id="优化方案" tabindex="-1"><a class="header-anchor" href="#优化方案" aria-hidden="true">#</a> 优化方案</h5>
<p>改为sql联表查询，而非mybatis-plus单表查询</p>
<p>思路：</p>
<ul>
<li>
<p>exam表是主表，拼接条件查询这张表即可</p>
</li>
<li>
<p>判断是否有阅卷权限时不适用id in，使用内连接</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span>
	 ee<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span>
	ex_exam ee <span class="token punctuation">,</span>ex_exam_reviewer er
<span class="token keyword">WHERE</span>
ee<span class="token punctuation">.</span>id <span class="token operator">=</span> er<span class="token punctuation">.</span>exam_id 
<span class="token operator">and</span> 
<span class="token punctuation">(</span>er<span class="token punctuation">.</span>reviewer_id <span class="token operator">=</span> <span class="token string">"ALL"</span> <span class="token operator">OR</span> er<span class="token punctuation">.</span>reviewer_id <span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>判断考试是否包含人工阅卷，使用子查询，且是分页查</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> <span class="token number">1</span> a <span class="token keyword">from</span> ex_answer_record_detail a<span class="token punctuation">,</span> ex_exam_question q<span class="token punctuation">,</span> ex_answer_record ear <span class="token keyword">where</span> a<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ee<span class="token punctuation">.</span>id 
<span class="token operator">and</span> a<span class="token punctuation">.</span>question_id <span class="token operator">=</span> q<span class="token punctuation">.</span>id <span class="token operator">and</span> q<span class="token punctuation">.</span>question_type <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>record_id <span class="token operator">=</span> ear<span class="token punctuation">.</span>id <span class="token operator">and</span> ear<span class="token punctuation">.</span>is_del <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">limit</span> <span class="token number">1</span> 
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><p>由于有两种情况，Excel导入的考试和资源库引用的考试查exam_question表，组卷的考试查lib_question表，所以使用union all</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">select</span> <span class="token number">1</span> a <span class="token keyword">from</span> ex_answer_record_detail a<span class="token punctuation">,</span> ex_lib_question q <span class="token punctuation">,</span>ex_answer_record ear <span class="token keyword">where</span> a<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ee<span class="token punctuation">.</span>id <span class="token operator">and</span> a<span class="token punctuation">.</span>question_id <span class="token operator">=</span> q<span class="token punctuation">.</span>id <span class="token operator">and</span> q<span class="token punctuation">.</span>question_type <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>record_id <span class="token operator">=</span> ear<span class="token punctuation">.</span>id <span class="token operator">and</span> ear<span class="token punctuation">.</span>is_del <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">limit</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>采用exists判断是否需要查询该考试数据</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> a <span class="token keyword">from</span> ex_answer_record_detail a<span class="token punctuation">,</span> ex_exam_question q<span class="token punctuation">,</span> ex_answer_record ear <span class="token keyword">where</span> a<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ee<span class="token punctuation">.</span>id 
<span class="token operator">and</span> a<span class="token punctuation">.</span>question_id <span class="token operator">=</span> q<span class="token punctuation">.</span>id <span class="token operator">and</span> q<span class="token punctuation">.</span>question_type <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>record_id <span class="token operator">=</span> ear<span class="token punctuation">.</span>id <span class="token operator">and</span> ear<span class="token punctuation">.</span>is_del <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> a <span class="token keyword">from</span> ex_answer_record_detail a<span class="token punctuation">,</span> ex_lib_question q <span class="token punctuation">,</span>ex_answer_record ear <span class="token keyword">where</span> a<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ee<span class="token punctuation">.</span>id <span class="token operator">and</span> a<span class="token punctuation">.</span>question_id <span class="token operator">=</span> q<span class="token punctuation">.</span>id <span class="token operator">and</span> q<span class="token punctuation">.</span>question_type <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>record_id <span class="token operator">=</span> ear<span class="token punctuation">.</span>id <span class="token operator">and</span> ear<span class="token punctuation">.</span>is_del <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>最终sql</p>
<div class="language-sql ext-sql line-numbers-mode"><pre v-pre class="language-sql"><code><span class="token keyword">SELECT</span>
	 ee<span class="token punctuation">.</span><span class="token operator">*</span>
<span class="token keyword">FROM</span>
	ex_exam ee <span class="token punctuation">,</span>ex_exam_reviewer er
<span class="token keyword">WHERE</span>
ee<span class="token punctuation">.</span>id <span class="token operator">=</span> er<span class="token punctuation">.</span>exam_id 
<span class="token operator">and</span> 
<span class="token punctuation">(</span>er<span class="token punctuation">.</span>reviewer_id <span class="token operator">=</span> <span class="token string">"ALL"</span> <span class="token operator">OR</span> er<span class="token punctuation">.</span>reviewer_id <span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>
<span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span> 
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> a <span class="token keyword">from</span> ex_answer_record_detail a<span class="token punctuation">,</span> ex_exam_question q<span class="token punctuation">,</span> ex_answer_record ear <span class="token keyword">where</span> a<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ee<span class="token punctuation">.</span>id 
<span class="token operator">and</span> a<span class="token punctuation">.</span>question_id <span class="token operator">=</span> q<span class="token punctuation">.</span>id <span class="token operator">and</span> q<span class="token punctuation">.</span>question_type <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>record_id <span class="token operator">=</span> ear<span class="token punctuation">.</span>id <span class="token operator">and</span> ear<span class="token punctuation">.</span>is_del <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">limit</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token keyword">union</span> <span class="token keyword">all</span>
<span class="token punctuation">(</span><span class="token keyword">select</span> <span class="token number">1</span> a <span class="token keyword">from</span> ex_answer_record_detail a<span class="token punctuation">,</span> ex_lib_question q <span class="token punctuation">,</span>ex_answer_record ear <span class="token keyword">where</span> a<span class="token punctuation">.</span>exam_id <span class="token operator">=</span> ee<span class="token punctuation">.</span>id <span class="token operator">and</span> a<span class="token punctuation">.</span>question_id <span class="token operator">=</span> q<span class="token punctuation">.</span>id <span class="token operator">and</span> q<span class="token punctuation">.</span>question_type <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">and</span> a<span class="token punctuation">.</span>record_id <span class="token operator">=</span> ear<span class="token punctuation">.</span>id <span class="token operator">and</span> ear<span class="token punctuation">.</span>is_del <span class="token operator">=</span> <span class="token number">0</span> <span class="token keyword">limit</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
	<span class="token operator">and</span> ee<span class="token punctuation">.</span>exam_type <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token operator">and</span> ee<span class="token punctuation">.</span>publish_time <span class="token operator">>=</span> <span class="token string">''</span>
	<span class="token operator">and</span> ee<span class="token punctuation">.</span>publish_time <span class="token operator">&lt;=</span> <span class="token string">''</span>
	<span class="token operator">and</span> ee<span class="token punctuation">.</span>ex_exam <span class="token operator">like</span> <span class="token string">"%examName%"</span>
	<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> ee<span class="token punctuation">.</span>publish_time<span class="token punctuation">,</span>ee<span class="token punctuation">.</span>create_time
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>
<li>
<p>执行耗时</p>
<p><img src="http://www.iocaop.com/images/2022-08/202208191057296.png" alt="执行耗时"></p>
</li>
</ul>
<h5 id="方案落地" tabindex="-1"><a class="header-anchor" href="#方案落地" aria-hidden="true">#</a> 方案落地</h5>
<p>将步骤1和步骤2改为sql查询，后续步骤暂时不优化。</p>
<div class="language-xml ext-xml line-numbers-mode"><pre v-pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>getCorrectExamList<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>BaseResultMap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        SELECT
        ee.id as id,
        ee.exam_type as exam_type,
        ee.exam_name as exam_name,
        ee.description as description,
        ee.category_id as category_id,
        ee.start_time as start_time,
        ee.exam_time_count as exam_time_count,
        ee.end_time as end_time,
        ee.total_score as total_score,
        ee.pass_score as pass_score,
        ee.degree_difficult as degree_difficult,
        ee.is_allow_late as is_allow_late,
        ee.check_paper_method as check_paper_method,
        ee.source_type as source_type,
        ee.schema_id as schema_id,
        ee.is_re_exam as is_re_exam,
        ee.re_exam_count as re_exam_count,
        ee.is_view_answer as is_view_answer,
        ee.is_view_score as is_view_score,
        ee.is_view_ranking as is_view_ranking,
        ee.is_question_seq as is_question_seq,
        ee.is_option_seq as is_option_seq,
        ee.publish_by as publish_by,
        ee.is_publish as is_publish,
        ee.sort_no as sort_no,
        ee.is_available as is_available,
        ee.is_del as is_del,
        ee.create_by as create_by,
        ee.create_time as create_time,
        ee.update_by as update_by,
        ee.update_time as update_time,
        ee.org_id as org_id,
        ee.customer_id as customer_id,
        ee.is_train as is_train,
        ee.add_method as add_method,
        ee.equipment as equipment,
        ee.excel_flag as excel_flag
        FROM
        ex_exam ee ,ex_exam_reviewer er
        WHERE
        ee.id = er.exam_id
        and
        (er.reviewer_id = "ALL" OR er.reviewer_id =#{userId})
        and exists (
        (select 1 a from ex_answer_record_detail a, ex_exam_question q, ex_answer_record ear where a.exam_id = ee.id
        and a.question_id = q.id and q.question_type in (3,5) and a.record_id = ear.id and ear.is_del = 0 limit 1 )
        union all
        (select 1 a from ex_answer_record_detail a, ex_lib_question q ,ex_answer_record ear where a.exam_id = ee.id and
        a.question_id = q.id and q.question_type in (3,5) and a.record_id = ear.id and ear.is_del = 0 limit 1)
        )
        and ee.exam_type = 1
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>startTime!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            and ee.publish_time >> #{startTime}
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>endTime!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
            and #{endTime} >> ee.publish_time
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>examName!=null<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
           and ee.exam_name like CONCAT('%',#{examName},'%')
       <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">></span></span>
        ORDER BY ee.publish_time,ee.create_time
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java ext-java line-numbers-mode"><pre v-pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">></span></span> <span class="token function">getExamCorrectExamList</span><span class="token punctuation">(</span>
        <span class="token class-name">ExamCorrectExamListQueryDTO</span> examCorrectExamListQueryDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 参数</span>
        <span class="token class-name">String</span> examName <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getExamName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> pageNo <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getPageNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> pageSize <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getPageSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 发布时间范围</span>
        <span class="token class-name">String</span> startTime <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> endTime <span class="token operator">=</span> examCorrectExamListQueryDTO<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">validStr2Date</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">validStr2Date</span><span class="token punctuation">(</span>endTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userId <span class="token operator">=</span> <span class="token class-name">UserThreadContext</span><span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Exam</span><span class="token punctuation">></span></span> sqlPageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlPageInfo<span class="token punctuation">.</span><span class="token function">setPageSize</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sqlPageInfo<span class="token punctuation">.</span><span class="token function">setPageNum</span><span class="token punctuation">(</span>pageNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1 获取当前用户可以改卷的试卷id列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span> examIds <span class="token operator">=</span> examReviewerService<span class="token punctuation">.</span><span class="token function">getExamIdListByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2 过滤掉没有人工阅卷的答题记录的试卷id</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">></span></span> examCorrectExamListDTOList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>examIds<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sqlPageInfo <span class="token operator">=</span>
                <span class="token class-name">PageHelper</span><span class="token punctuation">.</span><span class="token function">startPage</span><span class="token punctuation">(</span>pageNo<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">doSelectPageInfo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> examService<span class="token punctuation">.</span><span class="token function">getCorrectExamList</span><span class="token punctuation">(</span>startTime<span class="token punctuation">,</span>endTime<span class="token punctuation">,</span> examName<span class="token punctuation">,</span> userId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 4 构建返回结果</span>
            examCorrectExamListDTOList <span class="token operator">=</span>
                sqlPageInfo<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>
                        exam <span class="token operator">-></span> <span class="token punctuation">{</span>
                            <span class="token comment">// 该考试的答题记录</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span> answerRecords <span class="token operator">=</span>
                                baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>
                                    <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerRecord</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">AnswerRecord</span><span class="token operator">::</span><span class="token function">getExamId</span><span class="token punctuation">,</span> exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 交卷人数</span>

                            <span class="token keyword">int</span> submitCount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>answerRecord <span class="token operator">-></span> answerRecord<span class="token punctuation">.</span><span class="token function">getIsPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_POST</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 已改卷数</span>
                            <span class="token keyword">int</span> reviewedCount <span class="token operator">=</span>
                                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
                                    answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                                            v <span class="token operator">-></span> v<span class="token punctuation">.</span><span class="token function">getIsCheckFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_CHECK_FINISH</span>
                                                <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span><span class="token function">getIsPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_POST</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token comment">// 未改卷数</span>
                            <span class="token keyword">int</span> unReviewedCount <span class="token operator">=</span>
                                <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>
                                    answerRecords<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>
                                            v <span class="token operator">-></span>
                                                v<span class="token punctuation">.</span><span class="token function">getIsCheckFinish</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                                    <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_NOT_CHECK_FINISH</span>
                                                    <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span><span class="token function">getIsPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_IS_POST</span><span class="token punctuation">)</span>
                                        <span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">ExamCorrectExamListDTO</span> examCorrectExamListDTO <span class="token operator">=</span> <span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examId</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examName</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getExamName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">totalScore</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getTotalScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">passScore</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getPassScore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">submitCount</span><span class="token punctuation">(</span>submitCount<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">reviewedCount</span><span class="token punctuation">(</span>reviewedCount<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">unReviewedCount</span><span class="token punctuation">(</span>unReviewedCount<span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examStartTime</span><span class="token punctuation">(</span>
                                    <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">formatToStr</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getStartTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DateHelper</span><span class="token punctuation">.</span><span class="token constant">YYYYMMDD_HHMMSS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examEndTime</span><span class="token punctuation">(</span>
                                    <span class="token class-name">DateUtil</span><span class="token punctuation">.</span><span class="token function">formatToStr</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DateHelper</span><span class="token punctuation">.</span><span class="token constant">YYYYMMDD_HHMMSS</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">examStatus</span><span class="token punctuation">(</span>
                                    exam<span class="token punctuation">.</span><span class="token function">getEndTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token operator">?</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_STATUS_ON</span>
                                        <span class="token operator">:</span> <span class="token class-name">ExamConstant</span><span class="token punctuation">.</span><span class="token constant">EXAM_STATUS_NOT_ON</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">createBy</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getCreateBy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">secretLevel</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getSecretLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">Integer</span> examQuestionCount<span class="token punctuation">;</span>
                            <span class="token class-name">Integer</span> examSubjectiveQuestionCount<span class="token punctuation">;</span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                <span class="token operator">==</span> <span class="token class-name">QuestionSourceTypeEnum</span><span class="token punctuation">.</span><span class="token constant">ENTER_SOURCE</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                examQuestionCount <span class="token operator">=</span> schemaDetailService<span class="token punctuation">.</span><span class="token function">getQuestionCountBySchemaId</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getSchemaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                examSubjectiveQuestionCount <span class="token operator">=</span> schemaDetailService<span class="token punctuation">.</span><span class="token function">getSubjectiveQuestionCountBySchemaId</span><span class="token punctuation">(</span>
                                    exam<span class="token punctuation">.</span><span class="token function">getSchemaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                                examSubjectiveQuestionCount <span class="token operator">=</span> examQuestionService<span class="token punctuation">.</span><span class="token function">getSubjectiveQuestionCount</span><span class="token punctuation">(</span>
                                    exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                examQuestionCount <span class="token operator">=</span> examService<span class="token punctuation">.</span><span class="token function">getExamQuestionCount</span><span class="token punctuation">(</span>exam<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            examCorrectExamListDTO<span class="token punctuation">.</span><span class="token function">setSubjectiveQuestionCount</span><span class="token punctuation">(</span>examSubjectiveQuestionCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            examCorrectExamListDTO<span class="token punctuation">.</span><span class="token function">setQuestionCount</span><span class="token punctuation">(</span>examQuestionCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> examCorrectExamListDTO<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 5分页</span>
        <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExamCorrectExamListDTO</span><span class="token punctuation">></span></span> resultPageInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PageInfo</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BeanUtils</span><span class="token punctuation">.</span><span class="token function">copyProperties</span><span class="token punctuation">(</span>sqlPageInfo<span class="token punctuation">,</span> resultPageInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resultPageInfo<span class="token punctuation">.</span><span class="token function">setList</span><span class="token punctuation">(</span>examCorrectExamListDTOList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> resultPageInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="优化结果" tabindex="-1"><a class="header-anchor" href="#优化结果" aria-hidden="true">#</a> 优化结果</h5>
<p>可以正常查询出数据</p>
<p><img src="http://www.iocaop.com/images/2022-08/202208191057929.png" alt="优化结果"></p>
</div></template>


